services:
  backup-orchestrator:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - stack.env
    environment:
      TZ: "America/Sao_Paulo"
      CONFIG_FILE: "/backups/config/backups.yml"
      BACKUP_DIR: "/backups"
      LOG_DIR: "/backups/logs"
    volumes:
      # Host backup directory
      - /mnt/sda/backups/financer:/backups
      # Configuration files
      - ./backups.yml:/backups/config/backups.yml:ro
      - ./backup.sh:/backup.sh:ro
      # Docker socket for volume backups
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - financer-services_database
    entrypoint: |
      /bin/bash -c '
      # Install required tools
      apt-get update && apt-get install -y --no-install-recommends \
        awscli \
        docker.io \
        cron \
        bash \
        >/dev/null 2>&1 || {
          echo "Failed to install packages" >&2
          exit 1
        }

      # Make backup script executable
      chmod +x /backup.sh

      # Create cron job for daily backup at 3am
      CRON_JOB="0 3 * * * /backup.sh"
      echo "$$CRON_JOB" | crontab -

      echo "=========================================="
      echo "Backup orchestrator started"
      echo "Timezone: $$TZ"
      echo "Backup directory: $$BACKUP_DIR"
      echo "Configuration file: $$CONFIG_FILE"
      echo "Cron job: $$CRON_JOB"
      echo "=========================================="

      # Start cron daemon in foreground
      exec cron -f
      '

networks:
  financer-services_database:
    external: true
