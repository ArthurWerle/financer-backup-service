services:
  backup-orchestrator:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - stack.env
    environment:
      TZ: "America/Sao_Paulo"
      CONFIG_FILE: "/backups/config/backups.yml"
      BACKUP_DIR: "/backups"
      LOG_DIR: "/backups/logs"
    volumes:
      # Host backup directory
      - /mnt/sda/backups/financer:/backups
      # Configuration files
      - ./backups.yml:/backups/config/backups.yml:ro
      - ./backup.sh:/backup.sh
      # Docker socket for volume backups
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - financer-services_database
    entrypoint: |
      /bin/bash -c '
      # Install required tools
      apt-get update && apt-get install -y --no-install-recommends \
        awscli \
        docker.io \
        bash \
        >/dev/null 2>&1 || {
          echo "Failed to install packages" >&2
          exit 1
        }

      # Make backup script executable
      chmod +x /backup.sh

      # Use BACKUP_INTERVAL with default of 86400 seconds (1 day)
      INTERVAL=$${BACKUP_INTERVAL:-86400}

      echo "=========================================="
      echo "Backup orchestrator started"
      echo "Timezone: $$TZ"
      echo "Backup directory: $$BACKUP_DIR"
      echo "Configuration file: $$CONFIG_FILE"
      echo "Backup interval: $$INTERVAL seconds ($$(( INTERVAL / 3600 )) hours)"
      echo "=========================================="

      # Run backup loop
      while true; do
        echo "[$(date +'\''%Y-%m-%d %H:%M:%S'\'')] Running backup..."
        /backup.sh
        BACKUP_EXIT_CODE=$$?

        if [ $$BACKUP_EXIT_CODE -eq 0 ]; then
          echo "[$(date +'\''%Y-%m-%d %H:%M:%S'\'')] Backup completed successfully"
        else
          echo "[$(date +'\''%Y-%m-%d %H:%M:%S'\'')] Backup failed with exit code $$BACKUP_EXIT_CODE"
        fi

        echo "[$(date +'\''%Y-%m-%d %H:%M:%S'\'')] Sleeping for $$INTERVAL seconds (next backup at $(date -d "@$$(( $$(date +%s) + INTERVAL ))" +'\''%Y-%m-%d %H:%M:%S'\''))"
        sleep $$INTERVAL
      done
      '

networks:
  financer-services_database:
    external: true
