services:
  backup-orchestrator:
    image: postgres:15
    restart: unless-stopped
    env_file:
      - stack.env
    environment:
      TZ: "America/Sao_Paulo"
      BACKUP_INTERVAL: "${BACKUP_INTERVAL:-86400}"
    volumes:
      - /mnt/sda/backups/financer:/backups
    networks:
      - financer-services_database
    entrypoint: |
      /bin/bash -c '
      set -e

      echo "=========================================="
      echo "Installing backup tools..."
      apt-get update > /dev/null 2>&1
      apt-get install -y --no-install-recommends awscli > /dev/null 2>&1
      echo "Tools installed successfully"
      echo "=========================================="
      echo "Backup Service Started"
      echo "Timezone: America/Sao_Paulo"
      echo "Backup interval: $${BACKUP_INTERVAL} seconds"
      echo "=========================================="

      while true; do
        TIMESTAMP=$$(date +%Y%m%d_%H%M%S)
        BACKUP_DIR="/backups/$${TIMESTAMP}"

        echo ""
        echo "[$(date +"%Y-%m-%d %H:%M:%S")] Starting backup: $${TIMESTAMP}"
        echo "----------------------------------------"

        # Create backup directory
        mkdir -p "$${BACKUP_DIR}"

        # Backup mordor database
        echo "[$(date +"%Y-%m-%d %H:%M:%S")] Backing up mordor database..."
        export PGPASSWORD="$${POSTGRES_PASSWORD}"
        if pg_dump -h "$${POSTGRES_HOST}" -p "$${POSTGRES_PORT:-5432}" -U "$${POSTGRES_USER}" mordor | gzip > "$${BACKUP_DIR}/mordor_$${TIMESTAMP}.sql.gz"; then
          SIZE=$$(du -h "$${BACKUP_DIR}/mordor_$${TIMESTAMP}.sql.gz" | cut -f1)
          echo "[$(date +"%Y-%m-%d %H:%M:%S")] ✓ Mordor backup completed ($${SIZE})"
        else
          echo "[$(date +"%Y-%m-%d %H:%M:%S")] ✗ Mordor backup failed"
        fi

        # Backup transactions database (optional)
        if [ -n "$${TRANSACTIONS_HOST}" ]; then
          echo "[$(date +"%Y-%m-%d %H:%M:%S")] Backing up transactions database..."
          export PGPASSWORD="$${TRANSACTIONS_PASSWORD:-$${POSTGRES_PASSWORD}}"
          if pg_dump -h "$${TRANSACTIONS_HOST}" -p "$${TRANSACTIONS_PORT:-5433}" -U "$${TRANSACTIONS_USER:-$${POSTGRES_USER}}" transactions | gzip > "$${BACKUP_DIR}/transactions_$${TIMESTAMP}.sql.gz" 2>/dev/null; then
            SIZE=$$(du -h "$${BACKUP_DIR}/transactions_$${TIMESTAMP}.sql.gz" | cut -f1)
            echo "[$(date +"%Y-%m-%d %H:%M:%S")] ✓ Transactions backup completed ($${SIZE})"
          else
            echo "[$(date +"%Y-%m-%d %H:%M:%S")] ⚠ Transactions backup skipped (database not available)"
          fi
        fi

        # Sync to S3
        if [ -n "$${S3_BUCKET}" ]; then
          echo "[$(date +"%Y-%m-%d %H:%M:%S")] Syncing to S3..."
          if aws s3 sync "$${BACKUP_DIR}" "s3://$${S3_BUCKET}/$${TIMESTAMP}/" --region "$${AWS_DEFAULT_REGION:-us-east-1}" > /dev/null 2>&1; then
            echo "[$(date +"%Y-%m-%d %H:%M:%S")] ✓ S3 sync completed"
          else
            echo "[$(date +"%Y-%m-%d %H:%M:%S")] ✗ S3 sync failed"
          fi
        else
          echo "[$(date +"%Y-%m-%d %H:%M:%S")] ⚠ S3_BUCKET not set, skipping sync"
        fi

        # Keep only last 5 backups
        echo "[$(date +"%Y-%m-%d %H:%M:%S")] Cleaning old backups (keeping last 5)..."
        cd /backups
        ls -t | grep -E "^[0-9]{8}_[0-9]{6}$$" | tail -n +6 | xargs -r rm -rf

        echo "----------------------------------------"
        echo "[$(date +"%Y-%m-%d %H:%M:%S")] Backup completed: $${TIMESTAMP}"
        echo "[$(date +"%Y-%m-%d %H:%M:%S")] Next backup in $${BACKUP_INTERVAL} seconds"

        sleep $${BACKUP_INTERVAL}
      done
      '

networks:
  financer-services_database:
    external: true
